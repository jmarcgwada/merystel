/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a strict data ownership model. Users can only
 * manage their own user documents. Access to company-level data is
 * restricted to authenticated users. No public data access is allowed.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /companies/{companyId}: Root for all company-specific data.
 * - Under each company: /customers, /suppliers, /categories, /items, /tables, /sales, /paymentMethods, /vatRates, /heldOrders.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - All company subcollections require the user to be authenticated to read or write.
 *
 * Pattern: Ownership
 * The `/users/{userId}` collection follows the Ownership pattern. Users can only
 * read and write their own user document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get,update,delete) User with ID 'user123' can read their own profile.
     * @deny (get,list,create,update,delete) User with ID 'user456' cannot access user ID 'user123' profile.
     * @principle Enforces user-ownership: Only the authenticated user can access their own data.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to company information.
     * @path /companies/{companyId}
     * @allow (get) Authenticated user can get company information.
     * @allow (list) Listing is not allowed.
     * @deny (create,update,delete) No one can create, update, or delete company information directly.
     * @principle Authenticated user can access company, but create/update/delete is prohibited.
     */
    match /companies/{companyId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to customer data within a company.
     * @path /companies/{companyId}/customers/{customerId}
     * @allow (get,list) Authenticated user can read customer data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete customer data.
     * @principle Authenticated user can access customer data.
     */
    match /companies/{companyId}/customers/{customerId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to supplier data within a company.
     * @path /companies/{companyId}/suppliers/{supplierId}
     * @allow (get,list) Authenticated user can read supplier data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete supplier data.
     * @principle Authenticated user can access supplier data.
     */
    match /companies/{companyId}/suppliers/{supplierId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to category data within a company.
     * @path /companies/{companyId}/categories/{categoryId}
     * @allow (get,list) Authenticated user can read category data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete category data.
     * @principle Authenticated user can access category data.
     */
    match /companies/{companyId}/categories/{categoryId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to item data within a company.
     * @path /companies/{companyId}/items/{itemId}
     * @allow (get,list) Authenticated user can read item data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete item data.
     * @principle Authenticated user can access item data.
     */
    match /companies/{companyId}/items/{itemId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to table data within a company.
     * @path /companies/{companyId}/tables/{tableId}
     * @allow (get,list) Authenticated user can read table data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete table data.
     * @principle Authenticated user can access table data.
     */
    match /companies/{companyId}/tables/{tableId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to sale data within a company.
     * @path /companies/{companyId}/sales/{saleId}
     * @allow (get,list) Authenticated user can read sale data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete sale data.
     * @principle Authenticated user can access sale data.
     */
    match /companies/{companyId}/sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to payment method data within a company.
     * @path /companies/{companyId}/paymentMethods/{methodId}
     * @allow (get,list) Authenticated user can read payment method data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete payment method data.
     * @principle Authenticated user can access payment method data.
     */
    match /companies/{companyId}/paymentMethods/{methodId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to VAT rate data within a company.
     * @path /companies/{companyId}/vatRates/{vatId}
     * @allow (get,list) Authenticated user can read VAT rate data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete VAT rate data.
     * @principle Authenticated user can access VAT rate data.
     */
    match /companies/{companyId}/vatRates/{vatId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to held order data within a company.
     * @path /companies/{companyId}/heldOrders/{orderId}
     * @allow (get,list) Authenticated user can read held order data.
     * @deny (create,update,delete) Only authenticated users can create, update and delete held order data.
     * @principle Authenticated user can access held order data.
     */
    match /companies/{companyId}/heldOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}