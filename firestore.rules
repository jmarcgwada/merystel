/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a strict company-ownership model. Users can only
 * access data belonging to their assigned company. All write operations
 * require a valid authenticated user. Data structure enforces a clear
 * hierarchy with company-specific data nested under /companies/{companyId}.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /companies/{companyId}: Stores company information. The root for all
 *   company-specific data.
 * - /companies/{companyId}/customers/{customerId}: Customer data.
 * - /companies/{companyId}/categories/{categoryId}: Item categories.
 * - /companies/{companyId}/items/{itemId}: Sellable items.
 * - /companies/{companyId}/tables/{tableId}: Restaurant tables.
 * - /companies/{companyId}/sales/{saleId}: Sales records.
 * - /companies/{companyId}/paymentMethods/{methodId}: Payment methods.
 * - /companies/{companyId}/vatRates/{vatId}: VAT rates.
 * - /companies/{companyId}/heldOrders/{orderId}: Held orders.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile data (/users/{userId}).
 * - Company-level data is accessible to users belonging to that company.
 *   This is verified by checking the user's companyId claim against the
 *   companyId in the path.
 * - Listing of users is disallowed.
 *
 * Denormalization for Authorization:
 * - The `User` document includes a `companyId` field, which is used to
 *   authorize access to company-specific data. This avoids the need for
 *   additional reads to determine company membership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own user profile.
     * @path /users/{userId}
     * @allow (read, write) User with matching userId can access their profile.
     *   Example: User with UID "user123" can read/write /users/user123.
     * @deny (read, write) User with UID "user123" cannot read/write /users/otherUser.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) ;
      allow delete: if isOwner(userId) ;
    }

    /**
     * @description Allows access to company data based on user's companyId.
     * @path /companies/{companyId}
     * @allow (read) Authenticated user can read company data if their companyId matches.
     *   Example: User with companyId "company123" can read /companies/company123.
     * @deny (read) Authenticated user cannot read company data if their companyId does not match.
     * @principle Enforces company-level access control.
     */
    match /companies/{companyId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to customer data for users within the same company.
     * @path /companies/{companyId}/customers/{customerId}
     * @allow (read, write) Authenticated user can access customer data if their companyId matches.
     *   Example: User with companyId "company123" can read/write /companies/company123/customers/cust456.
     * @deny (read, write) User with companyId "company123" cannot read/write /companies/otherCompany/customers/cust456.
     * @principle Enforces company-level access control for customer data.
     */
    match /companies/{companyId}/customers/{customerId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if isUserInCompany(companyId);
      allow create: if isUserInCompany(companyId);
      allow update: if isUserInCompany(companyId);
      allow delete: if isUserInCompany(companyId);
    }

    /**
     * @description Allows access to item category data for users within the same company.
     * @path /companies/{companyId}/categories/{categoryId}
     * @allow (read, write) Authenticated user can access category data if their companyId matches.
     *   Example: User with companyId "company123" can read/write /companies/company123/categories/cat789.
     * @deny (read, write) User with companyId "company123" cannot read/write /companies/otherCompany/categories/cat789.
     * @principle Enforces company-level access control for item categories.
     */
    match /companies/{companyId}/categories/{categoryId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if isUserInCompany(companyId);
      allow create: if isUserInCompany(companyId);
      allow update: if isUserInCompany(companyId);
      allow delete: if isUserInCompany(companyId);
    }

    /**
     * @description Allows access to item data for users within the same company.
     * @path /companies/{companyId}/items/{itemId}
     * @allow (read, write) Authenticated user can access item data if their companyId matches.
     *   Example: User with companyId "company123" can read/write /companies/company123/items/item101.
     * @deny (read, write) User with companyId "company123" cannot read/write /companies/otherCompany/items/item101.
     * @principle Enforces company-level access control for items.
     */
    match /companies/{companyId}/items/{itemId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if isUserInCompany(companyId);
      allow create: if isUserInCompany(companyId);
      allow update: if isUserInCompany(companyId);
      allow delete: if isUserInCompany(companyId);
    }

    /**
     * @description Allows access to table data for users within the same company.
     * @path /companies/{companyId}/tables/{tableId}
     * @allow (read, write) Authenticated user can access table data if their companyId matches.
     *   Example: User with companyId "company123" can read/write /companies/company123/tables/tableA.
     * @deny (read, write) User with companyId "company123" cannot read/write /companies/otherCompany/tables/tableA.
     * @principle Enforces company-level access control for tables.
     */
    match /companies/{companyId}/tables/{tableId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if isUserInCompany(companyId);
      allow create: if isUserInCompany(companyId);
      allow update: if isUserInCompany(companyId);
      allow delete: if isUserInCompany(companyId);
    }

    /**
     * @description Allows access to sale data for users within the same company.
     * @path /companies/{companyId}/sales/{saleId}
     * @allow (read, write) Authenticated user can access sale data if their companyId matches.
     *   Example: User with companyId "company123" can read/write /companies/company123/sales/sale001.
     * @deny (read, write) User with companyId "company123" cannot read/write /companies/otherCompany/sales/sale001.
     * @principle Enforces company-level access control for sales.
     */
    match /companies/{companyId}/sales/{saleId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if isUserInCompany(companyId);
      allow create: if isUserInCompany(companyId);
      allow update: if isUserInCompany(companyId);
      allow delete: if isUserInCompany(companyId);
    }

    /**
     * @description Allows access to payment method data for users within the same company.
     * @path /companies/{companyId}/paymentMethods/{methodId}
     * @allow (read, write) Authenticated user can access payment method data if their companyId matches.
     *   Example: User with companyId "company123" can read/write /companies/company123/paymentMethods/methodA.
     * @deny (read, write) User with companyId "company123" cannot read/write /companies/otherCompany/paymentMethods/methodA.
     * @principle Enforces company-level access control for payment methods.
     */
    match /companies/{companyId}/paymentMethods/{methodId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if isUserInCompany(companyId);
      allow create: if isUserInCompany(companyId);
      allow update: if isUserInCompany(companyId);
      allow delete: if isUserInCompany(companyId);
    }

    /**
     * @description Allows access to VAT rate data for users within the same company.
     * @path /companies/{companyId}/vatRates/{vatId}
     * @allow (read, write) Authenticated user can access VAT rate data if their companyId matches.
     *   Example: User with companyId "company123" can read/write /companies/company123/vatRates/vat5.
     * @deny (read, write) User with companyId "company123" cannot read/write /companies/otherCompany/vatRates/vat5.
     * @principle Enforces company-level access control for VAT rates.
     */
    match /companies/{companyId}/vatRates/{vatId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if isUserInCompany(companyId);
      allow create: if isUserInCompany(companyId);
      allow update: if isUserInCompany(companyId);
      allow delete: if isUserInCompany(companyId);
    }

    /**
     * @description Allows access to held order data for users within the same company.
     * @path /companies/{companyId}/heldOrders/{orderId}
     * @allow (read, write) Authenticated user can access held order data if their companyId matches.
     *   Example: User with companyId "company123" can read/write /companies/company123/heldOrders/orderH1.
     * @deny (read, write) User with companyId "company123" cannot read/write /companies/otherCompany/heldOrders/orderH1.
     * @principle Enforces company-level access control for held orders.
     */
    match /companies/{companyId}/heldOrders/{orderId} {
      function isUserInCompany(companyId) {
        return request.auth != null && request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }
      allow get: if isUserInCompany(companyId);
      allow list: if isUserInCompany(companyId);
      allow create: if isUserInCompany(companyId);
      allow update: if isUserInCompany(companyId);
      allow delete: if isUserInCompany(companyId);
    }
  }
}