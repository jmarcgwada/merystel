/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a strict company-based data isolation model. All data
 * is nested under /companies/{companyId}, and users must be authenticated
 * and associated with a company to access company-specific data.  User data
 * is stored under /users/{userId} and is accessible only to the user themselves.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /companies/{companyId}: Stores company-level data.
 * - /companies/{companyId}/{collections}: All company-related data is stored
 *   under company-specific subcollections.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - All company-related writes require the user to be authenticated.
 * - Rules are designed for rapid prototyping and do not enforce strict
 *   schema validation beyond authorization-critical fields.
 *
 * Denormalization for Authorization:
 * - User documents should contain a `companyId` field to simplify company-based
 *   authorization checks. This avoids needing to query separate collections to
 *   determine a user's company affiliation.
 *
 * Structural Segregation:
 * - Public vs. private data is managed through collection placement.  There
 *   are no public collections in this data model.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profile information.
     * @path /users/{userId}
     * @allow (create) User with matching ID can create their own profile.
     * @allow (get, list, update, delete) User can access their own profile.
     * @deny (create) User cannot create a profile with a mismatched ID.
     * @deny (update, delete) User cannot modify or delete another user's profile.
     * @principle Enforces user-ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to company information.
     * @path /companies/{companyId}
     * @allow (get, list) Anyone can view company information.
     * @allow (create) Only authenticated users can create a company profile.
     * @allow (update, delete) Only the company owner (admin user) can update or delete the company profile.
     * @deny (create) Anonymous users cannot create a company profile.
     * @deny (update, delete) Non-owners cannot update or delete company information.
     * @principle Enforces company-level ownership for company data.
     */
    match /companies/{companyId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Implement owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to customer information within a company.
     * @path /companies/{companyId}/customers/{customerId}
     * @allow (get, list) Authenticated users can read customer data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage customer data.
     * @deny (create, update, delete) Users from other companies cannot manage customer data.
     * @principle Enforces company-based access control for customer data.
     */
    match /companies/{companyId}/customers/{customerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Grants access to supplier information within a company.
     * @path /companies/{companyId}/suppliers/{supplierId}
     * @allow (get, list) Authenticated users can read supplier data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage supplier data.
     * @deny (create, update, delete) Users from other companies cannot manage supplier data.
     * @principle Enforces company-based access control for supplier data.
     */
    match /companies/{companyId}/suppliers/{supplierId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Grants access to item categories within a company.
     * @path /companies/{companyId}/categories/{categoryId}
     * @allow (get, list) Authenticated users can read item category data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage item category data.
     * @deny (create, update, delete) Users from other companies cannot manage item category data.
     * @principle Enforces company-based access control for item category data.
     */
    match /companies/{companyId}/categories/{categoryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }
        /**
     * @description Grants access to categories subcollection within a company.
     * @path /companies/{companyId}/categories
     * @allow (list) Authenticated users can list categories data within their company.
     * @deny (get,create, update, delete) All operations are denied
     * @principle Enforces company-based access control for categories listing.
     */
    match /companies/{companyId}/categories {
        function isSignedIn() {
          return request.auth != null;
        }
        allow list: if isSignedIn();
        allow get, create, update, delete: if false;
    }

    /**
     * @description Grants access to items within a company.
     * @path /companies/{companyId}/items/{itemId}
     * @allow (get, list) Authenticated users can read item data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage item data.
     * @deny (create, update, delete) Users from other companies cannot manage item data.
     * @principle Enforces company-based access control for item data.
     */
    match /companies/{companyId}/items/{itemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Grants access to tables within a company.
     * @path /companies/{companyId}/tables/{tableId}
     * @allow (get, list) Authenticated users can read table data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage table data.
     * @deny (create, update, delete) Users from other companies cannot manage table data.
     * @principle Enforces company-based access control for table data.
     */
    match /companies/{companyId}/tables/{tableId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Grants access to sales within a company.
     * @path /companies/{companyId}/sales/{saleId}
     * @allow (get, list) Authenticated users can read sale data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage sale data.
     * @deny (create, update, delete) Users from other companies cannot manage sale data.
     * @principle Enforces company-based access control for sale data.
     */
    match /companies/{companyId}/sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Grants access to payment methods within a company.
     * @path /companies/{companyId}/paymentMethods/{methodId}
     * @allow (get, list) Authenticated users can read payment method data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage payment method data.
     * @deny (create, update, delete) Users from other companies cannot manage payment method data.
     * @principle Enforces company-based access control for payment method data.
     */
    match /companies/{companyId}/paymentMethods/{methodId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Grants access to VAT rates within a company.
     * @path /companies/{companyId}/vatRates/{vatId}
     * @allow (get, list) Authenticated users can read VAT rate data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage VAT rate data.
     * @deny (create, update, delete) Users from other companies cannot manage VAT rate data.
     * @principle Enforces company-based access control for VAT rate data.
     */
    match /companies/{companyId}/vatRates/{vatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Grants access to held orders within a company.
     * @path /companies/{companyId}/heldOrders/{orderId}
     * @allow (get, list) Authenticated users can read held order data within their company.
     * @allow (create, update, delete) Only authenticated users associated with the company can manage held order data.
     * @deny (create, update, delete) Users from other companies cannot manage held order data.
     * @principle Enforces company-based access control for held order data.
     */
    match /companies/{companyId}/heldOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }
  }
}