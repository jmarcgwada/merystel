rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get) User with ID 'user123' can read their own profile.
     * @allow (update) User with ID 'user123' can update their own profile.
     * @allow (delete) User with ID 'user123' can delete their own profile.
     * @deny (create) User with ID 'user456' cannot create a profile for 'user123'.
     * @deny (get) User with ID 'user456' cannot read the profile of 'user123'.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to company root documents.
     * @path /companies/{companyId}
     * @allow (get) Authenticated user can read a company document.
     * @allow (list) Authenticated user can list companies (generally not recommended).
     * @deny (create) Only allowed through custom backend logic
     * @deny (update) No direct client-side updates allowed.
     * @deny (delete) No direct client-side deletes allowed.
     * @principle Requires authentication for access to company data.
     */
    match /companies/{companyId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to customer documents within a company.
     * @path /companies/{companyId}/customers/{customerId}
     * @allow (create) Authenticated user can create a customer for their company.
     * @allow (get) Authenticated user can read a customer for their company.
     * @allow (update) Authenticated user can update a customer for their company.
     * @allow (delete) Authenticated user can delete a customer for their company.
     * @deny (create) Unauthenticated user cannot create a customer.
     * @deny (get) User from another company cannot read this customer.
     * @principle Enforces company-level data access for customers.
     */
    match /companies/{companyId}/customers/{customerId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && exists(resource);
      allow delete: if isSignedIn() && exists(resource);
    }

    /**
     * @description Controls access to category documents within a company.
     * @path /companies/{companyId}/categories/{categoryId}
     * @allow (create) Authenticated user can create a category for their company.
     * @allow (get) Authenticated user can read a category for their company.
     * @allow (update) Authenticated user can update a category for their company.
     * @allow (delete) Authenticated user can delete a category for their company.
     * @deny (create) Unauthenticated user cannot create a category.
     * @deny (get) User from another company cannot read this category.
     * @principle Enforces company-level data access for categories.
     */
    match /companies/{companyId}/categories/{categoryId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && exists(resource);
      allow delete: if isSignedIn() && exists(resource);
    }

    /**
     * @description Controls access to item documents within a company.
     * @path /companies/{companyId}/items/{itemId}
     * @allow (create) Authenticated user can create an item for their company.
     * @allow (get) Authenticated user can read an item for their company.
     * @allow (update) Authenticated user can update an item for their company.
     * @allow (delete) Authenticated user can delete an item for their company.
     * @deny (create) Unauthenticated user cannot create an item.
     * @deny (get) User from another company cannot read this item.
     * @principle Enforces company-level data access for items.
     */
    match /companies/{companyId}/items/{itemId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && exists(resource);
      allow delete: if isSignedIn() && exists(resource);
    }

    /**
     * @description Controls access to table documents within a company.
     * @path /companies/{companyId}/tables/{tableId}
     * @allow (create) Authenticated user can create a table for their company.
     * @allow (get) Authenticated user can read a table for their company.
     * @allow (update) Authenticated user can update a table for their company.
     * @allow (delete) Authenticated user can delete a table for their company.
     * @deny (create) Unauthenticated user cannot create a table.
     * @deny (get) User from another company cannot read this table.
     * @principle Enforces company-level data access for tables.
     */
    match /companies/{companyId}/tables/{tableId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && exists(resource);
      allow delete: if isSignedIn() && exists(resource);
    }

    /**
     * @description Controls access to sale documents within a company.
     * @path /companies/{companyId}/sales/{saleId}
     * @allow (create) Authenticated user can create a sale for their company.
     * @allow (get) Authenticated user can read a sale for their company.
     * @allow (update) Authenticated user can update a sale for their company.
     * @allow (delete) Authenticated user can delete a sale for their company.
     * @deny (create) Unauthenticated user cannot create a sale.
     * @deny (get) User from another company cannot read this sale.
     * @principle Enforces company-level data access for sales.
     */
    match /companies/{companyId}/sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && exists(resource);
      allow delete: if isSignedIn() && exists(resource);
    }

    /**
     * @description Controls access to payment method documents within a company.
     * @path /companies/{companyId}/paymentMethods/{methodId}
     * @allow (create) Authenticated user can create a payment method for their company.
     * @allow (get) Authenticated user can read a payment method for their company.
     * @allow (update) Authenticated user can update a payment method for their company.
     * @allow (delete) Authenticated user can delete a payment method for their company.
     * @deny (create) Unauthenticated user cannot create a payment method.
     * @deny (get) User from another company cannot read this payment method.
     * @principle Enforces company-level data access for payment methods.
     */
    match /companies/{companyId}/paymentMethods/{methodId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && exists(resource);
      allow delete: if isSignedIn() && exists(resource);
    }

    /**
     * @description Controls access to VAT rate documents within a company.
     * @path /companies/{companyId}/vatRates/{vatId}
     * @allow (create) Authenticated user can create a VAT rate for their company.
     * @allow (get) Authenticated user can read a VAT rate for their company.
     * @allow (update) Authenticated user can update a VAT rate for their company.
     * @allow (delete) Authenticated user can delete a VAT rate for their company.
     * @deny (create) Unauthenticated user cannot create a VAT rate.
     * @deny (get) User from another company cannot read this VAT rate.
     * @principle Enforces company-level data access for VAT rates.
     */
    match /companies/{companyId}/vatRates/{vatId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && exists(resource);
      allow delete: if isSignedIn() && exists(resource);
    }

    /**
     * @description Controls access to held order documents within a company.
     * @path /companies/{companyId}/heldOrders/{orderId}
     * @allow (create) Authenticated user can create a held order for their company.
     * @allow (get) Authenticated user can read a held order for their company.
     * @allow (update) Authenticated user can update a held order for their company.
     * @allow (delete) Authenticated user can delete a held order for their company.
     * @deny (create) Unauthenticated user cannot create a held order.
     * @deny (get) User from another company cannot read this held order.
     * @principle Enforces company-level data access for held orders.
     */
    match /companies/{companyId}/heldOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && exists(resource);
      allow delete: if isSignedIn() && exists(resource);
    }
  }
}