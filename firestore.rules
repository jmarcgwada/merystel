/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a strict data ownership model, primarily based on user and company IDs.
 * Users can only manage their own profile data. Company-level data is generally accessible to
 * authenticated users belonging to that company, with some restrictions on modification.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles, accessible only to the user themselves.
 * - /companies/{companyId}: Stores company-level information.
 * - /companies/{companyId}/customers/{customerId}: Stores customers for a company.
 * - /companies/{companyId}/suppliers/{supplierId}: Stores suppliers for a company.
 * - /companies/{companyId}/categories/{categoryId}: Stores item categories.
 * - /companies/{companyId}/items/{itemId}: Stores items for sale.
 * - /companies/{companyId}/tables/{tableId}: Stores restaurant table information.
 * - /companies/{companyId}/sales/{saleId}: Stores completed sales transactions.
 * - /companies/{companyId}/paymentMethods/{methodId}: Stores payment methods.
 * - /companies/{companyId}/vatRates/{vatId}: Stores VAT rates.
 * - /companies/{companyId}/heldOrders/{orderId}: Stores temporarily held orders.
 *
 * Key Security Decisions:
 * - User listing is disallowed to prevent unauthorized access to user data.
 * - Company-level data is generally accessible to authenticated users. More granular role-based
 *   access control (admin, manager, cashier) could be implemented in the future.
 * - Data validation is relaxed in this prototyping phase to allow for rapid schema iteration.
 *
 * Denormalization for Authorization:
 *  - Company ID is included in the user document to avoid needing to query companies to authorize
 *    access to company-owned resources.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and write their own user profile.
     * @path /users/{userId}
     * @allow (get, create, update, delete) if request.auth.uid == userId
     * @deny (get, create, update, delete) if request.auth.uid != userId
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is not allowed.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows read access to company information for authenticated users.
     *  Write access is not granted in this prototype.
     * @path /companies/{companyId}
     * @allow (get, list) if isSignedIn()
     * @deny (create, update, delete) always
     * @principle Authenticated access to company data.
     */
    match /companies/{companyId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read/write access to customer data for authenticated users.
     * @path /companies/{companyId}/customers/{customerId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to customer data within a company.
     */
    match /companies/{companyId}/customers/{customerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read/write access to supplier data for authenticated users.
     * @path /companies/{companyId}/suppliers/{supplierId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to supplier data within a company.
     */
    match /companies/{companyId}/suppliers/{supplierId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read/write access to category data for authenticated users.
     * @path /companies/{companyId}/categories/{categoryId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to category data within a company.
     */
    match /companies/{companyId}/categories/{categoryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read/write access to item data for authenticated users.
     * @path /companies/{companyId}/items/{itemId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to item data within a company.
     */
    match /companies/{companyId}/items/{itemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read/write access to table data for authenticated users.
     * @path /companies/{companyId}/tables/{tableId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to table data within a company.
     */
    match /companies/{companyId}/tables/{tableId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read/write access to sale data for authenticated users.
     * @path /companies/{companyId}/sales/{saleId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to sale data within a company.
     */
    match /companies/{companyId}/sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read/write access to payment method data for authenticated users.
     * @path /companies/{companyId}/paymentMethods/{methodId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to payment method data within a company.
     */
    match /companies/{companyId}/paymentMethods/{methodId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read/write access to VAT rate data for authenticated users.
     * @path /companies/{companyId}/vatRates/{vatId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to VAT rate data within a company.
     */
    match /companies/{companyId}/vatRates/{vatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read/write access to held order data for authenticated users.
     * @path /companies/{companyId}/heldOrders/{orderId}
     * @allow (get, list) if isSignedIn()
     * @allow (create, update, delete) if isSignedIn()
     * @principle Authenticated access to held order data within a company.
     */
    match /companies/{companyId}/heldOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }
}