/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a strict company-based data isolation model. Users can only
 * access data associated with the company they belong to.  User documents are
 * secured via owner-only access.
 *
 * Data Structure:
 * - /users/{userId}: User profile information.
 * - /companies/{companyId}: Company root information.
 * - /companies/{companyId}/{collection}/{documentId}: Company-specific data,
 *   including customers, categories, items, tables, sales, payment methods,
 *   VAT rates, and held orders.
 *
 * Key Security Decisions:
 * - Users can only list payment methods and other company-specific data for their
 *   own company.
 * - User listing is not permitted to prevent unauthorized access to user data.
 *
 * Denormalization for Authorization:
 * - The `companyId` field within the User document is used to quickly verify
 *   company membership, avoiding the need for additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the resource and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Stores user profile information.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their own user document.
     *   Request: auth.uid = 'user123', resource.data.id = 'user123'
     * @deny (create) - User with UID 'user123' attempts to create a user document for 'user456'.
     *   Request: auth.uid = 'user123', resource.data.id = 'user456'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores root information for a company.
     * @path /companies/{companyId}
     */
    match /companies/{companyId} {
      allow get: if true;
      allow list: if false;
      allow create: if false; // TODO: Decide who can create a company
      allow update: if false; // TODO: Decide who can update a company
      allow delete: if false; // TODO: Decide who can delete a company

       match /{documentId}/{anypath=**} {
          allow read, write: if false;
       }
    }

    /**
     * @description Stores customer data for a specific company.
     * @path /companies/{companyId}/customers/{customerId}
     */
    match /companies/{companyId}/customers/{customerId} {
      allow get: if false; // TODO: Decide on get requirements
      allow list: if false; // TODO: Decide on list requirements
      allow create: if false; // TODO: Decide who can create a customer
      allow update: if false; // TODO: Decide who can update a customer
      allow delete: if false; // TODO: Decide who can delete a customer
    }

    /**
     * @description Item categories for a company.
     * @path /companies/{companyId}/categories/{categoryId}
     */
    match /companies/{companyId}/categories/{categoryId} {
      allow get: if false; // TODO: Decide on get requirements
      allow list: if false; // TODO: Decide on list requirements
      allow create: if false; // TODO: Decide who can create a category
      allow update: if false; // TODO: Decide who can update a category
      allow delete: if false; // TODO: Decide who can delete a category
    }

    /**
     * @description All sellable items for a company.
     * @path /companies/{companyId}/items/{itemId}
     */
    match /companies/{companyId}/items/{itemId} {
      allow get: if false; // TODO: Decide on get requirements
      allow list: if false; // TODO: Decide on list requirements
      allow create: if false; // TODO: Decide who can create an item
      allow update: if false; // TODO: Decide who can update an item
      allow delete: if false; // TODO: Decide who can delete an item
    }

    /**
     * @description Restaurant tables for a company.
     * @path /companies/{companyId}/tables/{tableId}
     */
    match /companies/{companyId}/tables/{tableId} {
      allow get: if false; // TODO: Decide on get requirements
      allow list: if false; // TODO: Decide on list requirements
      allow create: if false; // TODO: Decide who can create a table
      allow update: if false; // TODO: Decide who can update a table
      allow delete: if false; // TODO: Decide who can delete a table
    }

    /**
     * @description Record of all completed sales for a company.
     * @path /companies/{companyId}/sales/{saleId}
     */
    match /companies/{companyId}/sales/{saleId} {
      allow get: if false; // TODO: Decide on get requirements
      allow list: if false; // TODO: Decide on list requirements
      allow create: if false; // TODO: Decide who can create a sale
      allow update: if false; // TODO: Decide who can update a sale
      allow delete: if false; // TODO: Decide who can delete a sale
    }

    /**
     * @description Payment methods configured for a company.
     * @path /companies/{companyId}/paymentMethods/{methodId}
     * @allow (list) - User with UID 'FhQle9Qk0IhIc4XHHVbidjwRQII3' can list payment methods.
     *   Request: auth.uid = 'FhQle9Qk0IhIc4XHHVbidjwRQII3', User.companyId == companyId
     * @deny (list) - User with UID 'FhQle9Qk0IhIc4XHHVbidjwRQII3' attempts to list payment methods for another company.
     *   Request: auth.uid = 'FhQle9Qk0IhIc4XHHVbidjwRQII3', User.companyId != companyId
     * @principle Restricts access to a user's own company data.
     */
    match /companies/{companyId}/paymentMethods/{methodId} {
        allow get: if false; // TODO: Decide who can get a payment method
        allow list: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
        allow create: if false; // TODO: Decide who can create a payment method
        allow update: if false; // TODO: Decide who can update a payment method
        allow delete: if false; // TODO: Decide who can delete a payment method
    }

    /**
     * @description VAT rates configured for a company.
     * @path /companies/{companyId}/vatRates/{vatId}
     */
    match /companies/{companyId}/vatRates/{vatId} {
      allow get: if false; // TODO: Decide who can get a vat rate
      allow list: if false; // TODO: Decide who can list vat rates
      allow create: if false; // TODO: Decide who can create a vat rate
      allow update: if false; // TODO: Decide who can update a vat rate
      allow delete: if false; // TODO: Decide who can delete a vat rate
    }

    /**
     * @description Temporarily held orders for a company.
     * @path /companies/{companyId}/heldOrders/{orderId}
     */
    match /companies/{companyId}/heldOrders/{orderId} {
      allow get: if false; // TODO: Decide who can get a held order
      allow list: if false; // TODO: Decide who can list held orders
      allow create: if false; // TODO: Decide who can create a held order
      allow update: if false; // TODO: Decide who can update a held order
      allow delete: if false; // TODO: Decide who can delete a held order
    }
  }
}