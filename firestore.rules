/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a hybrid security model, balancing open access with
 * owner-based restrictions. The primary principle is to ensure data
 * consistency and prevent unauthorized modifications. The application has
 * authentication functionality.
 * This ruleset enforces a strict user-ownership model where users can only
 * access their own data, and company data is protected behind authentication
 * and role-based access.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles. Accessible only by the
 *   user themselves.
 * - /companies/{companyId}: Root collection for company-specific data.
 * - Under each /companies/{companyId}:
 *   - /customers/{customerId}: Customer data for the company. Accessible only
 *     by authenticated users of the company.
 *   - /categories/{categoryId}: Item categories. Accessible only by
 *     authenticated users of the company.
 *   - /items/{itemId}: Sellable items. Accessible only by authenticated users
 *     of the company.
 *   - /tables/{tableId}: Restaurant tables. Accessible only by authenticated
 *     users of the company.
 *   - /sales/{saleId}: Sales records. Accessible only by authenticated users
 *     of the company.
 *   - /paymentMethods/{methodId}: Payment methods. Accessible only by
 *     authenticated users of the company.
 *   - /vatRates/{vatId}: VAT rates. Accessible only by authenticated users
 *     of the company.
 *   - /heldOrders/{orderId}: Temporarily held orders. Accessible only by
 *     authenticated users of the company.
 *   - /suppliers/{supplierId}: Suppliers. Accessible only by authenticated users
 *     of the company.
 *
 * Key Security Decisions:
 * - Users can only read/write their own user document.
 * - Company-owned data (customers, items, etc.) requires authentication to
 *   access. More fine-grained role-based access control (admin, manager,
 *   cashier) can be implemented within the company subcollections.
 * - User listing is disallowed for privacy.
 *
 * Denormalization for Authorization:
 * - User documents MUST contain a `companyId` field to link them to a specific company. This is validated on creation and is immutable on update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {bool} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId The user ID to compare against.
     * @return {bool} True if the user IDs match, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner and the document exists.
     * @param {string} userId The user ID to compare against.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Allows read and write access to user profiles only to the authenticated user.
     * @path /users/{userId}
     * @allow (get, create, update, delete) Only the authenticated user can read, create, update, and delete their own user document.
     * @deny (get) If the authenticated user ID does not match the {userId} in the path.
     * @deny (create) If the authenticated user ID does not match the {userId} in the path.
     * @deny (update) If the authenticated user ID does not match the {userId} in the path.
     * @deny (delete) If the authenticated user ID does not match the {userId} in the path.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is disallowed

      // Self-creation: Allow creating the user document if the userId matches the authenticated user's uid.
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;

      // On Update: Enforce immutability for critical relational fields like `id`.
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;

      // Only the owner can delete their account.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows read and write access to company data only to authenticated users.
     * @path /companies/{companyId}
     * @allow (get, list) Any authenticated user can read any company document.
     * @allow (create) Any authenticated user can create a company document.
     * @allow (update) Any authenticated user can update a company document.
     * @allow (delete) Any authenticated user can delete a company document.
     * @deny None.
     * @principle Requires authentication for company data access.
     */
    match /companies/{companyId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();

      /**
       * @description Allows read and write access to customer data for a company only to authenticated users.
       * @path /companies/{companyId}/customers/{customerId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any customer document within a company.
       * @deny None.
       * @principle Requires authentication for customer data access.
       */
      match /customers/{customerId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }

      /**
       * @description Allows read and write access to supplier data for a company only to authenticated users.
       * @path /companies/{companyId}/suppliers/{supplierId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any supplier document within a company.
       * @deny None.
       * @principle Requires authentication for supplier data access.
       */
       match /suppliers/{supplierId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }

      /**
       * @description Allows read and write access to item categories for a company only to authenticated users.
       * @path /companies/{companyId}/categories/{categoryId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any category document within a company.
       * @deny None.
       * @principle Requires authentication for category data access.
       */
      match /categories/{categoryId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }

      /**
       * @description Allows read and write access to sellable items for a company only to authenticated users.
       * @path /companies/{companyId}/items/{itemId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any item document within a company.
       * @deny None.
       * @principle Requires authentication for item data access.
       */
      match /items/{itemId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }

      /**
       * @description Allows read and write access to restaurant tables for a company only to authenticated users.
       * @path /companies/{companyId}/tables/{tableId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any table document within a company.
       * @deny None.
       * @principle Requires authentication for table data access.
       */
      match /tables/{tableId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }

      /**
       * @description Allows read and write access to sales records for a company only to authenticated users.
       * @path /companies/{companyId}/sales/{saleId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any sale document within a company.
       * @deny None.
       * @principle Requires authentication for sale data access.
       */
      match /sales/{saleId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }

      /**
       * @description Allows read and write access to payment methods for a company only to authenticated users.
       * @path /companies/{companyId}/paymentMethods/{methodId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any payment method document within a company.
       * @deny None.
       * @principle Requires authentication for payment method data access.
       */
      match /paymentMethods/{methodId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }

      /**
       * @description Allows read and write access to VAT rates for a company only to authenticated users.
       * @path /companies/{companyId}/vatRates/{vatId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any vat rate document within a company.
       * @deny None.
       * @principle Requires authentication for VAT rate data access.
       */
      match /vatRates/{vatId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }

      /**
       * @description Allows read and write access to held orders for a company only to authenticated users.
       * @path /companies/{companyId}/heldOrders/{orderId}
       * @allow (get, list, create, update, delete) Any authenticated user can read, create, update, and delete any held order document within a company.
       * @deny None.
       * @principle Requires authentication for held order data access.
       */
      match /heldOrders/{orderId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }
    }
  }
}