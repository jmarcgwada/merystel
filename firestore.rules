/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model for user and company data.
 * Users can only access their own profile information.
 * All company-related data is segregated under a /companies/{companyId} path,
 * with access generally restricted to authenticated users. Listing of users is forbidden.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /companies/{companyId}: Root for all company-specific data.
 * - /companies/{companyId}/...: Various subcollections for company data (customers, items, etc.).
 *
 * Key Security Decisions:
 * - User listing is explicitly denied to prevent information leakage.
 * - Company access requires authentication. More granular roles may be added later.
 *
 * Denormalization for Authorization:
 * None currently.
 *
 * Structural Segregation:
 * All company-related data is kept under the /companies/{companyId} path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     * @param {string} userId The user ID to compare against.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID, and that resource exists.
     * @param {string} userId The user ID to compare against.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (get, update, delete) Authenticated user can only access/modify their own profile.
     * @deny (create) User cannot create a profile with an ID that doesn't match their own.
     * @deny (list) Listing users is not allowed.
     * @deny (update,delete) User cannot modify or delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get, update, delete: if isExistingOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow list: if false;
    }

    /**
     * @description Rules for company root documents.
     * @path /companies/{companyId}
     * @allow (get, list) Any authenticated user can view company information.
     * @allow (create) Only authenticated users can create a company.
     * @deny (update, delete) Only authenticated users can update or delete a company.
     * @principle Requires authentication for company data access.
     */
    match /companies/{companyId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Rules for customer data within a company.
     * @path /companies/{companyId}/customers/{customerId}
     * @allow (get, list) Any authenticated user can view customer data within a company.
     * @allow (create, update, delete) Only authenticated users can create, update, or delete customer data.
     * @principle Requires authentication for company customer data access.
     */
    match /companies/{companyId}/customers/{customerId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for item categories within a company.
     * @path /companies/{companyId}/categories/{categoryId}
     * @allow (get, list) Any authenticated user can view item categories within a company.
     * @allow (create, update, delete) Only authenticated users can create, update, or delete item categories.
     * @principle Requires authentication for company item categories data access.
     */
    match /companies/{companyId}/categories/{categoryId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

        /**
     * @description Rules for main item categories within a company.
     * @path /companies/{companyId}/categories/main/{categoryId}
     * @allow get, list: if isSignedIn();
     * @allow create, update, delete: if isSignedIn();
     */
    match /companies/{companyId}/categories/main/{categoryId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isSignedIn();
    }


    /**
     * @description Rules for sellable items within a company.
     * @path /companies/{companyId}/items/{itemId}
     * @allow (get, list) Any authenticated user can view items within a company.
     * @allow (create, update, delete) Only authenticated users can create, update, or delete items.
     * @principle Requires authentication for company items data access.
     */
    match /companies/{companyId}/items/{itemId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for restaurant tables within a company.
     * @path /companies/{companyId}/tables/{tableId}
     * @allow (get, list) Any authenticated user can view tables within a company.
     * @allow (create, update, delete) Only authenticated users can create, update, or delete tables.
     * @principle Requires authentication for company tables data access.
     */
    match /companies/{companyId}/tables/{tableId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for completed sales records within a company.
     * @path /companies/{companyId}/sales/{saleId}
     * @allow (get, list) Any authenticated user can view sales within a company.
     * @allow (create, update, delete) Only authenticated users can create, update, or delete sales records.
     * @principle Requires authentication for company sales data access.
     */
    match /companies/{companyId}/sales/{saleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for payment methods within a company.
     * @path /companies/{companyId}/paymentMethods/{methodId}
     * @allow (get, list) Any authenticated user can view payment methods within a company.
     * @allow (create, update, delete) Only authenticated users can create, update, or delete payment methods.
     * @principle Requires authentication for company payment methods data access.
     */
    match /companies/{companyId}/paymentMethods/{methodId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for VAT rates within a company.
     * @path /companies/{companyId}/vatRates/{vatId}
     * @allow (get, list) Any authenticated user can view VAT rates within a company.
     * @allow (create, update, delete) Only authenticated users can create, update, or delete VAT rates.
     * @principle Requires authentication for company VAT rates data access.
     */
    match /companies/{companyId}/vatRates/{vatId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for held orders within a company.
     * @path /companies/{companyId}/heldOrders/{orderId}
     * @allow (get, list) Any authenticated user can view held orders within a company.
     * @allow (create, update, delete) Only authenticated users can create, update, or delete held orders.
     * @principle Requires authentication for company held orders data access.
     */
    match /companies/{companyId}/heldOrders/{orderId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }
  }
}