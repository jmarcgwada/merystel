/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a strict data ownership model. Users can only
 * read and write their own profile data. All other data (companies,
 * customers, items, etc.) is scoped to a company and can only be
 * accessed by authenticated users who belong to that company.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /companies/{companyId}: Stores company-level data.
 * - All other collections are nested under /companies/{companyId}.
 *
 * Key Security Decisions:
 * - Users can only manage their own user profile.
 * - Listing users is disallowed.
 * - All company-related data requires the user to be authenticated.
 * - Assumes all company data is private and should not be accessible
 *   to the public.
 *
 * Denormalization for Authorization:
 * - The User document contains a `companyId` field. This is used to
 *   quickly verify a user's access to company-specific data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile if the userId matches their auth UID.
     * @allow (get) Authenticated user can read their own profile.
     * @allow (update) Authenticated user can update their own profile.
     * @allow (delete) Authenticated user can delete their own profile.
     * @deny (create) Authenticated user cannot create a profile with a mismatched userId.
     * @deny (get) Authenticated user cannot read another user's profile.
     * @deny (update) Authenticated user cannot update another user's profile.
     * @deny (delete) Authenticated user cannot delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      // isOwner allows users to only access their user
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && isExistingOwner(userId);
      allow delete: if isOwner(userId) && isExistingOwner(userId);
    }

    /**
     * @description Controls access to company information.
     * @path /companies/{companyId}
     * @allow (get) Authenticated user can read company information.
     * @allow (create) Authenticated user can create new company information.
     * @allow (update) Authenticated user can update company information.
     * @allow (delete) Authenticated user can delete company information.
     * @deny (get) Unauthorized user cannot read company information.
     * @deny (create) Unauthorized user cannot create company information.
     * @deny (update) Unauthorized user cannot update company information.
     * @deny (delete) Unauthorized user cannot delete company information.
     * @principle Requires authentication for all company data access.
     */
    match /companies/{companyId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;

      /**
       * @description Controls access to customer data for a specific company.
       * @path /companies/{companyId}/customers/{customerId}
       * @allow (get) Authenticated user of the company can read customer data.
       * @allow (create) Authenticated user of the company can create customer data.
       * @allow (update) Authenticated user of the company can update customer data.
       * @allow (delete) Authenticated user of the company can delete customer data.
       * @deny (get) Unauthorized user cannot read customer data.
       * @deny (create) Unauthorized user cannot create customer data.
       * @deny (update) Unauthorized user cannot update customer data.
       * @deny (delete) Unauthorized user cannot delete customer data.
       * @principle Requires authentication and company membership for customer data access.
       */
      match /customers/{customerId} {
        allow get: if isSignedIn() && isMemberOfCompany(companyId);
        allow list: if isSignedIn() && isMemberOfCompany(companyId);
        allow create: if isSignedIn() && isMemberOfCompany(companyId);
        allow update: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
        allow delete: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
      }

       /**
        * @description Controls access to item categories for a company.
        * @path /companies/{companyId}/categories/{categoryId}
        * @allow (get) Authenticated user of the company can read category data.
        * @allow (create) Authenticated user of the company can create category data.
        * @allow (update) Authenticated user of the company can update category data.
        * @allow (delete) Authenticated user of the company can delete category data.
        * @deny (get) Unauthorized user cannot read category data.
        * @deny (create) Unauthorized user cannot create category data.
        * @deny (update) Unauthorized user cannot update category data.
        * @deny (delete) Unauthorized user cannot delete category data.
        * @principle Requires authentication and company membership for category data access.
        */
      match /categories/{categoryId} {
        allow get: if isSignedIn() && isMemberOfCompany(companyId);
        allow list: if isSignedIn() && isMemberOfCompany(companyId);
        allow create: if isSignedIn() && isMemberOfCompany(companyId);
        allow update: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
        allow delete: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
      }

      /**
       * @description Controls access to sellable items for a company.
       * @path /companies/{companyId}/items/{itemId}
       * @allow (get) Authenticated user of the company can read item data.
       * @allow (create) Authenticated user of the company can create item data.
       * @allow (update) Authenticated user of the company can update item data.
       * @allow (delete) Authenticated user of the company can delete item data.
       * @deny (get) Unauthorized user cannot read item data.
       * @deny (create) Unauthorized user cannot create item data.
       * @deny (update) Unauthorized user cannot update item data.
       * @deny (delete) Unauthorized user cannot delete item data.
       * @principle Requires authentication and company membership for item data access.
       */
      match /items/{itemId} {
        allow get: if isSignedIn() && isMemberOfCompany(companyId);
        allow list: if isSignedIn() && isMemberOfCompany(companyId);
        allow create: if isSignedIn() && isMemberOfCompany(companyId);
        allow update: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
        allow delete: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
      }

      /**
       * @description Controls access to restaurant table data for a company.
       * @path /companies/{companyId}/tables/{tableId}
       * @allow (get) Authenticated user of the company can read table data.
       * @allow (create) Authenticated user of the company can create table data.
       * @allow (update) Authenticated user of the company can update table data.
       * @allow (delete) Authenticated user of the company can delete table data.
       * @deny (get) Unauthorized user cannot read table data.
       * @deny (create) Unauthorized user cannot create table data.
       * @deny (update) Unauthorized user cannot update table data.
       * @deny (delete) Unauthorized user cannot delete table data.
       * @principle Requires authentication and company membership for table data access.
       */
      match /tables/{tableId} {
        allow get: if isSignedIn() && isMemberOfCompany(companyId);
        allow list: if isSignedIn() && isMemberOfCompany(companyId);
        allow create: if isSignedIn() && isMemberOfCompany(companyId);
        allow update: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
        allow delete: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
      }

      /**
       * @description Controls access to sales data for a company.
       * @path /companies/{companyId}/sales/{saleId}
       * @allow (get) Authenticated user of the company can read sales data.
       * @allow (create) Authenticated user of the company can create sales data.
       * @allow (update) Authenticated user of the company can update sales data.
       * @allow (delete) Authenticated user of the company can delete sales data.
       * @deny (get) Unauthorized user cannot read sales data.
       * @deny (create) Unauthorized user cannot create sales data.
       * @deny (update) Unauthorized user cannot update sales data.
       * @deny (delete) Unauthorized user cannot delete sales data.
       * @principle Requires authentication and company membership for sales data access.
       */
      match /sales/{saleId} {
        allow get: if isSignedIn() && isMemberOfCompany(companyId);
        allow list: if isSignedIn() && isMemberOfCompany(companyId);
        allow create: if isSignedIn() && isMemberOfCompany(companyId);
        allow update: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
        allow delete: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
      }

      /**
       * @description Controls access to payment method data for a company.
       * @path /companies/{companyId}/paymentMethods/{methodId}
       * @allow (get) Authenticated user of the company can read payment method data.
       * @allow (create) Authenticated user of the company can create payment method data.
       * @allow (update) Authenticated user of the company can update payment method data.
       * @allow (delete) Authenticated user of the company can delete payment method data.
       * @deny (get) Unauthorized user cannot read payment method data.
       * @deny (create) Unauthorized user cannot create payment method data.
       * @deny (update) Unauthorized user cannot update payment method data.
       * @deny (delete) Unauthorized user cannot delete payment method data.
       * @principle Requires authentication and company membership for payment method data access.
       */
      match /paymentMethods/{methodId} {
        allow get: if isSignedIn() && isMemberOfCompany(companyId);
        allow list: if isSignedIn() && isMemberOfCompany(companyId);
        allow create: if isSignedIn() && isMemberOfCompany(companyId);
        allow update: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
        allow delete: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
      }

      /**
       * @description Controls access to VAT rate data for a company.
       * @path /companies/{companyId}/vatRates/{vatId}
       * @allow (get) Authenticated user of the company can read VAT rate data.
       * @allow (create) Authenticated user of the company can create VAT rate data.
       * @allow (update) Authenticated user of the company can update VAT rate data.
       * @allow (delete) Authenticated user of the company can delete VAT rate data.
       * @deny (get) Unauthorized user cannot read VAT rate data.
       * @deny (create) Unauthorized user cannot create VAT rate data.
       * @deny (update) Unauthorized user cannot update VAT rate data.
       * @deny (delete) Unauthorized user cannot delete VAT rate data.
       * @principle Requires authentication and company membership for VAT rate data access.
       */
      match /vatRates/{vatId} {
        allow get: if isSignedIn() && isMemberOfCompany(companyId);
        allow list: if isSignedIn() && isMemberOfCompany(companyId);
        allow create: if isSignedIn() && isMemberOfCompany(companyId);
        allow update: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
        allow delete: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
      }

      /**
       * @description Controls access to held order data for a company.
       * @path /companies/{companyId}/heldOrders/{orderId}
       * @allow (get) Authenticated user of the company can read held order data.
       * @allow (create) Authenticated user of the company can create held order data.
       * @allow (update) Authenticated user of the company can update held order data.
       * @allow (delete) Authenticated user of the company can delete held order data.
       * @deny (get) Unauthorized user cannot read held order data.
       * @deny (create) Unauthorized user cannot create held order data.
       * @deny (update) Unauthorized user cannot update held order data.
       * @deny (delete) Unauthorized user cannot delete held order data.
       * @principle Requires authentication and company membership for held order data access.
       */
      match /heldOrders/{orderId} {
        allow get: if isSignedIn() && isMemberOfCompany(companyId);
        allow list: if isSignedIn() && isMemberOfCompany(companyId);
        allow create: if isSignedIn() && isMemberOfCompany(companyId);
        allow update: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
        allow delete: if isSignedIn() && isMemberOfCompany(companyId) && resource != null;
      }
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && getAfter().data != null;
  }

  function isMemberOfCompany(companyId) {
    return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
  }
}