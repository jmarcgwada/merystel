/**
 * @file Firebase Security Rules for Zenith POS.
 *
 * @core_philosophy This ruleset enforces a strict, hierarchical ownership model. Users own their profiles.
 * Companies own all data nested under their respective company ID.
 *
 * @data_structure
 * - /users/{userId}: User profile information.
 * - /companies/{companyId}: Company root document.
 * - /companies/{companyId}/customers/{customerId}: Customers belonging to a company.
 * - /companies/{companyId}/suppliers/{supplierId}: Suppliers for a company.
 * - /companies/{companyId}/categories/{categoryId}: Item categories for a company.
 * - /companies/{companyId}/items/{itemId}: Items (products/services) for a company.
 * - /companies/{companyId}/tables/{tableId}: Tables for a restaurant company.
 * - /companies/{companyId}/sales/{saleId}: Sales records for a company.
 * - /companies/{companyId}/paymentMethods/{methodId}: Payment methods for a company.
 * - /companies/{companyId}/vatRates/{vatId}: VAT rates for a company.
 * - /companies/{companyId}/heldOrders/{orderId}: Held orders for a company.
 *
 * @key_security_decisions
 * - Users can only access their own user document.
 * - Companies are secured such that only authenticated users can read them.
 * - All company-owned data is accessible only to authenticated users.
 * - Listing of users is disallowed.
 * - Users must be signed in to access company data.
 * - The rule for /companies/{companyId}/suppliers/{supplierId} was creating an additional read. To reduce firestore reads, the logic was simplified to ensure that users must be signed in to create, update or delete the document.
 *
 * @denormalization_for_authorization
 *  - Company ID is implicitly denormalized onto all documents within the /companies/{companyId}/** tree.
 *  - User ID is denormalized onto the /users/{userId} document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     *   request.auth.uid: 'user123', request.resource.data.id: 'user123'
     * @deny (create) User with ID 'user123' cannot create a profile for 'user456'.
     *   request.auth.uid: 'user123', request.resource.data.id: 'user456'
     * @allow (get, update, delete) User with ID 'user123' can read/update/delete their profile.
     *   request.auth.uid: 'user123', userId: 'user123'
     * @deny (get, update, delete) User with ID 'user123' cannot read/update/delete profile for 'user456'.
     *   request.auth.uid: 'user123', userId: 'user456'
     * @principle Enforces document ownership; users can only manage their own profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to company root documents.
     * @path /companies/{companyId}
     * @allow (get, list) Authenticated user can read company information.
     *   request.auth.uid: 'user123'
     * @deny (create, update, delete) No direct creation, update, or deletion of company documents.
     * @principle Companies are typically created and managed via backend processes.
     */
    match /companies/{companyId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;

      /**
       * @description Controls access to customer documents within a company.
       * @path /companies/{companyId}/customers/{customerId}
       * @allow (get, list) Authenticated user can read customer information within the company.
       *   request.auth.uid: 'user123'
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /customers/{customerId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Controls access to supplier documents within a company.
       * @path /companies/{companyId}/suppliers/{supplierId}
       * @allow (get, list) Authenticated user can read supplier information within the company.
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /suppliers/{supplierId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Controls access to category documents within a company.
       * @path /companies/{companyId}/categories/{categoryId}
       * @allow (get, list) Authenticated user can read category information within the company.
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /categories/{categoryId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Controls access to item documents within a company.
       * @path /companies/{companyId}/items/{itemId}
       * @allow (get, list) Authenticated user can read item information within the company.
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /items/{itemId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Controls access to table documents within a company.
       * @path /companies/{companyId}/tables/{tableId}
       * @allow (get, list) Authenticated user can read table information within the company.
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /tables/{tableId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Controls access to sale documents within a company.
       * @path /companies/{companyId}/sales/{saleId}
       * @allow (get, list) Authenticated user can read sale information within the company.
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /sales/{saleId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Controls access to payment method documents within a company.
       * @path /companies/{companyId}/paymentMethods/{methodId}
       * @allow (get, list) Authenticated user can read payment method information within the company.
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /paymentMethods/{methodId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Controls access to VAT rate documents within a company.
       * @path /companies/{companyId}/vatRates/{vatId}
       * @allow (get, list) Authenticated user can read VAT rate information within the company.
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /vatRates/{vatId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Controls access to held order documents within a company.
       * @path /companies/{companyId}/heldOrders/{orderId}
       * @allow (get, list) Authenticated user can read held order information within the company.
       * @deny (create, update, delete) No specific authorization implemented.
       * @principle Requires company context.
       */
      match /heldOrders/{orderId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }
    }
  }
}