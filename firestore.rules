/**
 * @fileoverview Firestore Security Rules for Zenith POS.
 *
 * Core Philosophy:
 * This ruleset enforces a strict data ownership model. Users can only
 * read and write their own profile data. All other data (companies,
 * customers, items, etc.) is scoped to a company and accessible only
 * by authenticated users who belong to that company.
 *
 * Data Structure:
 * - /users/{userId}: User profile information.
 * - /companies/{companyId}: Company information.
 * - /companies/{companyId}/customers/{customerId}: Customers of a company.
 * - /companies/{companyId}/categories/{categoryId}: Item categories.
 * - /companies/{companyId}/items/{itemId}: Sellable items.
 * - /companies/{companyId}/tables/{tableId}: Restaurant tables.
 * - /companies/{companyId}/sales/{saleId}: Completed sales.
 * - /companies/{companyId}/paymentMethods/{methodId}: Payment methods.
 * - /companies/{companyId}/vatRates/{vatId}: VAT rates.
 * - /companies/{companyId}/heldOrders/{orderId}: Held orders.
 *
 * Key Security Decisions:
 * - Users can only read/write their own user document. Listing all users is disallowed.
 * - All company-related data is only accessible by authenticated users.
 * - Data validation is relaxed in this prototyping phase.
 *
 * Denormalization for Authorization:
 *  - The `User` entity has a `companyId` field. This ID is used to grant access to all company-scoped data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (get, update, delete) - Authenticated user can get, update, and delete their own profile.
     * @deny (list) - Listing all users is not allowed.
     * @deny (create) - If the userId does not match the authenticated user id.
     * @deny (update, delete) - If the userId does not match the authenticated user id or resource doesn't exist.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      // isOwner must only check request.auth.uid, not request.auth
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // Enforce immutability of userId
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to company information.
     * @path /companies/{companyId}
     * @allow (get, list) - Authenticated users can read company information.
     * @allow (create) - No one can create companies through the client.
     * @allow (update, delete) - No one can update or delete companies through the client.
     * @deny (create, update, delete) - Preventing client-side creation, update, and deletion.
     * @principle Requires authentication for reading company data; restricts writing.
     */
    match /companies/{companyId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow get, list: if isSignedIn();
        allow create, update, delete: if false;
    }

    /**
     * @description Controls access to customer data for a specific company.
     * @path /companies/{companyId}/customers/{customerId}
     * @allow (get, list) - Authenticated users can read customer data for their company.
     * @allow (create) - Authenticated users can create customer data for their company.
     * @allow (update, delete) - Authenticated users can update and delete customer data for their company.
     * @deny (create, update, delete) - if not authenticated.
     * @principle Requires authentication for access to company customer data.
     */
    match /companies/{companyId}/customers/{customerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to item categories for a company.
     * @path /companies/{companyId}/categories/{categoryId}
     * @allow (get, list) - Authenticated users can read categories for their company.
     * @allow (create) - Authenticated users can create categories for their company.
     * @allow (update, delete) - Authenticated users can update and delete categories for their company.
     * @deny (create, update, delete) - if not authenticated.
     * @principle Requires authentication for access to company categories.
     */
    match /companies/{companyId}/categories/{categoryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to sellable items for a company.
     * @path /companies/{companyId}/items/{itemId}
     * @allow (get, list) - Authenticated users can read items for their company.
     * @allow (create) - Authenticated users can create items for their company.
     * @allow (update, delete) - Authenticated users can update and delete items for their company.
     * @deny (create, update, delete) - if not authenticated.
     * @principle Requires authentication for access to company items.
     */
    match /companies/{companyId}/items/{itemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to restaurant tables for a company.
     * @path /companies/{companyId}/tables/{tableId}
     * @allow (get, list) - Authenticated users can read tables for their company.
     * @allow (create) - Authenticated users can create tables for their company.
     * @allow (update, delete) - Authenticated users can update and delete tables for their company.
     * @deny (create, update, delete) - if not authenticated.
     * @principle Requires authentication for access to company tables.
     */
    match /companies/{companyId}/tables/{tableId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to completed sales records for a company.
     * @path /companies/{companyId}/sales/{saleId}
     * @allow (get, list) - Authenticated users can read sales records for their company.
     * @allow (create) - Authenticated users can create sales records for their company.
     * @allow (update, delete) - Authenticated users can update and delete sales records for their company.
     * @deny (create, update, delete) - if not authenticated.
     * @principle Requires authentication for access to company sales.
     */
    match /companies/{companyId}/sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to payment methods for a company.
     * @path /companies/{companyId}/paymentMethods/{methodId}
     * @allow (get, list) - Authenticated users can read payment methods for their company.
     * @allow (create) - Authenticated users can create payment methods for their company.
     * @allow (update, delete) - Authenticated users can update and delete payment methods for their company.
     * @deny (create, update, delete) - if not authenticated.
     * @principle Requires authentication for access to company payment methods.
     */
    match /companies/{companyId}/paymentMethods/{methodId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to VAT rates for a company.
     * @path /companies/{companyId}/vatRates/{vatId}
     * @allow (get, list) - Authenticated users can read VAT rates for their company.
     * @allow (create) - Authenticated users can create VAT rates for their company.
     * @allow (update, delete) - Authenticated users can update and delete VAT rates for their company.
     * @deny (create, update, delete) - if not authenticated.
     * @principle Requires authentication for access to company VAT rates.
     */
    match /companies/{companyId}/vatRates/{vatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to held orders for a company.
     * @path /companies/{companyId}/heldOrders/{orderId}
     * @allow (get, list) - Authenticated users can read held orders for their company.
     * @allow (create) - Authenticated users can create held orders for their company.
     * @allow (update, delete) - Authenticated users can update and delete held orders for their company.
     * @deny (create, update, delete) - if not authenticated.
     * @principle Requires authentication for access to company held orders.
     */
    match /companies/{companyId}/heldOrders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list, create, update, delete: if isSignedIn();
    }
  }
}